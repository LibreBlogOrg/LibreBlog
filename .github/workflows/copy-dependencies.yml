name: Copy NPM Dependencies

on:
  workflow_dispatch:

jobs:
  copy-deps:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install copyfiles
        run: npm install copyfiles --no-save

      - name: Install required npm modules
        run: |
          npm install @sqlite.org/sqlite-wasm@3.51.2-build5 \
                      twig@1.17.1 \
                      marked@17.0.1 \
                      ace-builds@1.43.6 \
                      jszip@3.10.1 --no-save

      - name: Create dependencies directories
        run: |
          mkdir -p dependencies/marked
          mkdir -p dependencies/sqlite3
          mkdir -p dependencies/twig
          mkdir -p dependencies/ace
          mkdir -p dependencies/ace/snippets
          mkdir -p dependencies/jszip

      - name: Copy files (matches script)
        run: |
          set -e
          npx copyfiles -V -f node_modules/marked/lib/marked.esm.js dependencies/marked/
          npx copyfiles -V -f node_modules/@sqlite.org/sqlite-wasm/sqlite-wasm/jswasm/sqlite3.mjs dependencies/sqlite3/
          npx copyfiles -V -f node_modules/@sqlite.org/sqlite-wasm/sqlite-wasm/jswasm/sqlite3.wasm dependencies/sqlite3/
          npx copyfiles -V -f node_modules/@sqlite.org/sqlite-wasm/sqlite-wasm/jswasm/sqlite3-opfs-async-proxy.js dependencies/sqlite3/
          npx copyfiles -V -f node_modules/twig/twig.min.js dependencies/twig/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-xml.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-twig.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-javascript.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-html.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-css.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-json.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/mode-markdown.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/ace.js dependencies/ace/
          npx copyfiles -V -f "node_modules/ace-builds/src-min/ext-*" dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/theme-github_light_default.js dependencies/ace/
          npx copyfiles -V -f node_modules/ace-builds/src-min/snippets/markdown.js dependencies/ace/snippets/
          npx copyfiles -V -f node_modules/jszip/dist/jszip.min.js dependencies/jszip/

      - name: Commit changes
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"
          git add dependencies
          git commit -m "Copy npm dependencies into dependencies/" || echo "No changes to commit"
          git push
